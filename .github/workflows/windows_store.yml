name: Windows Store Build and Release

on:
  push:
    branches: [ main ]
    paths:
      - "apps/terminal/pubspec.yaml"
      - "apps/terminal/lib/**"
      - "apps/terminal/windows/**"
      - ".github/workflows/windows_store.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    name: Build & Publish Windows App
    runs-on: windows-latest
    
    defaults:
      run:
        working-directory: apps/terminal

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Extract version and auto-increment with GitHub Run Number
      - name: Read & Bump Version
        id: version
        shell: bash
        run: |
          # Read base version (e.g., 0.0.3 from 0.0.3+19)
          BASE_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //;s/\+.*//')
          
          # Construct unique Windows version: Major.Minor.Patch.RunNumber
          AUTO_VERSION="${BASE_VERSION}+${{ github.run_number }}"
          
          echo "version=v$AUTO_VERSION" >> $GITHUB_OUTPUT
          echo "version_number=$AUTO_VERSION" >> $GITHUB_OUTPUT
          
          echo "ðŸ”¢ Base Version: $BASE_VERSION"
          echo "ðŸš€ Auto-incremented Version: $AUTO_VERSION"
          
          # Update pubspec.yaml so msix:create uses this version
          sed -i "s/^version: .*/version: $AUTO_VERSION/" pubspec.yaml

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:

          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-v2'

      # Create .env file from secrets
      - name: Create .env file
        shell: bash
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name: Create firebase_options.dart
        shell: bash
        env:
          FIREBASE_OPTIONS_BASE64: ${{ secrets.TERMINAL_FIREBASE_OPTIONS_BASE64 }}
        run: |
          if [ -n "$FIREBASE_OPTIONS_BASE64" ]; then
            echo "$FIREBASE_OPTIONS_BASE64" | base64 --decode > lib/firebase_options.dart
          else
            echo "::warning::TERMINAL_FIREBASE_OPTIONS_BASE64 not set, build may fail"
          fi

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      # ðŸ›¡ï¸ Quality Gates
      - name: Analyze code
        continue-on-error: true
        run: flutter analyze

      - name: Run Tests
        run: flutter test


      # ðŸ—ï¸ Build
      - name: Build Windows Release
        run: flutter build windows --release

      - name: Create MSIX
        run: dart run msix:create
        env:
          temp: true

      # ðŸ“ Changelog
      - name: Generate Changelog
        id: changelog
        shell: bash
        run: |
          echo "ðŸ“ Generating changelog..."
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s|%h")
          else
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s|%h" --no-merges)
          fi

          # Simple changelog generation
          echo "# What's New" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          while IFS='|' read -r MSG HASH; do
             if [ -n "$MSG" ]; then
               echo "- $MSG" >> RELEASE_NOTES.md
             fi
          done <<< "$COMMITS"
          
          cat RELEASE_NOTES.md

      # ðŸ“¦ Publish to Store
      - name: Install Microsoft Store CLI
        run: |
          winget install Microsoft.DotNet.DesktopRuntime.8 --accept-source-agreements --accept-package-agreements --silent
          winget install "Microsoft Store Developer CLI" --accept-source-agreements --accept-package-agreements --silent

      - name: Publish to Microsoft Store
        shell: pwsh
        run: |
          # Validation
          if (-not $env:WINDOWS_STORE_TENANT_ID) { Write-Error "WINDOWS_STORE_TENANT_ID is missing"; exit 1 }
          if (-not $env:WINDOWS_STORE_CLIENT_ID) { Write-Error "WINDOWS_STORE_CLIENT_ID is missing"; exit 1 }
          if (-not $env:WINDOWS_STORE_CLIENT_SECRET) { Write-Error "WINDOWS_STORE_CLIENT_SECRET is missing"; exit 1 }
          if (-not $env:WINDOWS_STORE_SELLER_ID) { Write-Error "WINDOWS_STORE_SELLER_ID is missing"; exit 1 }

          Write-Host "Reconfiguring MSStore CLI..."
          msstore reconfigure --tenantId $env:WINDOWS_STORE_TENANT_ID --clientId $env:WINDOWS_STORE_CLIENT_ID --clientSecret $env:WINDOWS_STORE_CLIENT_SECRET --sellerId $env:WINDOWS_STORE_SELLER_ID --verbose

          if ($LASTEXITCODE -ne 0) { Write-Error "msstore reconfigure failed"; exit 1 }

          Write-Host "Listing available apps..."
          msstore apps list

          Write-Host "Publishing to Store..."
          msstore publish --inputDirectory build/windows/x64/runner/Release --appId $env:WINDOWS_STORE_APP_ID --verbose
        env:
          WINDOWS_STORE_TENANT_ID: ${{ secrets.WINDOWS_STORE_TENANT_ID }}
          WINDOWS_STORE_CLIENT_ID: ${{ secrets.WINDOWS_STORE_CLIENT_ID }}
          WINDOWS_STORE_CLIENT_SECRET: ${{ secrets.WINDOWS_STORE_CLIENT_SECRET }}
          WINDOWS_STORE_SELLER_ID: ${{ secrets.WINDOWS_STORE_SELLER_ID }}
          WINDOWS_STORE_APP_ID: ${{ secrets.WINDOWS_STORE_APP_ID }}

      # ðŸš€ GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: apps/terminal/RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: apps/terminal/build/windows/runner/Release/*.msix

      - name: Upload MSIX Artifact (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: milow-terminal-msix
          path: apps/terminal/build/windows/runner/Release/*.msix
          if-no-files-found: warn




