name: Windows Store Build and Release

on:
  push:
    branches: [ beta ]
    paths:
      - "apps/terminal/pubspec.yaml"
      - "apps/terminal/lib/**"
      - "apps/terminal/windows/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    name: Build & Publish Windows App
    runs-on: windows-latest
    
    defaults:
      run:
        working-directory: apps/terminal

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Extract version from apps/terminal/pubspec.yaml (using bash on Windows)
      - name: Read version
        id: version
        shell: bash
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //;s/\+.*//')
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: v$VERSION"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.5"
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-v2'

      # Create .env file from secrets
      - name: Create .env file
        shell: bash
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      # ðŸ›¡ï¸ Quality Gates
      - name: Analyze code
        continue-on-error: true
        run: flutter analyze

      - name: Run Tests
        run: flutter test


      # ðŸ—ï¸ Build
      - name: Build Windows Release
        run: flutter build windows --release

      - name: Create MSIX
        run: dart run msix:create
        env:
          temp: true

      # ðŸ“ Changelog
      - name: Generate Changelog
        id: changelog
        shell: bash
        run: |
          echo "ðŸ“ Generating changelog..."
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s|%h")
          else
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s|%h" --no-merges)
          fi

          # Simple changelog generation
          echo "# What's New" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          while IFS='|' read -r MSG HASH; do
             if [ -n "$MSG" ]; then
               echo "- $MSG" >> RELEASE_NOTES.md
             fi
          done <<< "$COMMITS"
          
          cat RELEASE_NOTES.md

      # ðŸ“¦ Publish to Store
      - name: Install Microsoft Store CLI
        run: |
          winget install Microsoft.DotNet.DesktopRuntime.8 --accept-source-agreements --accept-package-agreements --silent
          winget install "Microsoft Store Developer CLI" --accept-source-agreements --accept-package-agreements --silent

      - name: Publish to Microsoft Store
        shell: pwsh
        run: |
          msstore reconfigure `
            --tenantId $env:WINDOWS_STORE_TENANT_ID `
            --clientId $env:WINDOWS_STORE_CLIENT_ID `
            --clientSecret $env:WINDOWS_STORE_CLIENT_SECRET `
            --sellerId $env:WINDOWS_STORE_SELLER_ID
          
          msstore publish `
            --inputDirectory build/windows/x64/runner/Release `
            --appId $env:WINDOWS_STORE_APP_ID `
            --verbose
        env:
          WINDOWS_STORE_TENANT_ID: ${{ secrets.WINDOWS_STORE_TENANT_ID }}
          WINDOWS_STORE_CLIENT_ID: ${{ secrets.WINDOWS_STORE_CLIENT_ID }}
          WINDOWS_STORE_CLIENT_SECRET: ${{ secrets.WINDOWS_STORE_CLIENT_SECRET }}
          WINDOWS_STORE_SELLER_ID: ${{ secrets.WINDOWS_STORE_SELLER_ID }}
          WINDOWS_STORE_APP_ID: ${{ secrets.WINDOWS_STORE_APP_ID }}

      # ðŸš€ GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: apps/terminal/RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: apps/terminal/build/windows/runner/Release/*.msix

      - name: Upload MSIX Artifact (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: milow-terminal-msix
          path: apps/terminal/build/windows/runner/Release/*.msix
          if-no-files-found: warn

      # Update Supabase with retry logic (Ported from Android Workflow)
      - name: Update Supabase Version
        continue-on-error: true
        shell: bash
        env:
          VERSION: ${{ steps.version.outputs.version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          # Secrets for Supabase
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ðŸ”„ Updating Supabase app version for Windows..."

          # Validate secrets
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_KEY" ]; then
            echo "::warning::Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY secrets. Skipping Supabase update."
            exit 0
          fi

          # Wait for GitHub to process the release (Optional, but good for logging)
          echo "â³ Waiting 5s..."
          sleep 5
          
          # Use the official Microsoft Store URL
          echo "ðŸ”— Setting download URL to Microsoft Store..."
          DOWNLOAD_URL="https://apps.microsoft.com/detail/9p641q1x1bmg?ocid=webpdpshare"
          
          # Construct JSON payload using pure strings
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Create a temp json file
          jq -n \
            --arg version "$VERSION" \
            --arg url "$DOWNLOAD_URL" \
            --arg changelog "Release $VERSION" \
            --arg time "$TIMESTAMP" \
            '{latest_version: $version, download_url: $url, changelog: $changelog, updated_at: $time}' > payload.json
          
          # Update Supabase (platform=windows)
          echo "ðŸ“¤ Sending update to Supabase..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
            "$SUPABASE_URL/rest/v1/app_version?platform=eq.windows" \
            -H "apikey: $SUPABASE_KEY" \
            -H "Authorization: Bearer $SUPABASE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d @payload.json)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Supabase updated successfully (HTTP $HTTP_CODE)"
          else
            echo "::error::Supabase update failed with HTTP $HTTP_CODE"
            echo "Response: $RESPONSE"
            exit 1
          fi


