name: Windows Store Build and Release

on:
  push:
    branches: [ beta ]
    paths:
      - "apps/terminal/pubspec.yaml"
      - "apps/terminal/lib/**"
      - "apps/terminal/windows/**"
      - ".github/workflows/windows_store.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # -----------------------------------------------------------------------------
  # Job 1: Quality Check (Tests, Lint, Security)
  # -----------------------------------------------------------------------------
  quality_check:
    name: ðŸ›¡ï¸ Quality Check
    runs-on: windows-latest
    defaults:
      run:
        working-directory: apps/terminal
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-v2'

      # Create .env file from secrets
      - name: Create .env file
        shell: bash
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name: Create firebase_options.dart
        shell: bash
        env:
          FIREBASE_OPTIONS_BASE64: ${{ secrets.TERMINAL_FIREBASE_OPTIONS_BASE64 }}
        run: |
          if [ -n "$FIREBASE_OPTIONS_BASE64" ]; then
            echo "$FIREBASE_OPTIONS_BASE64" | base64 --decode > lib/firebase_options.dart
          else
            echo "::warning::TERMINAL_FIREBASE_OPTIONS_BASE64 not set, build may fail"
          fi

      - name: Install dependencies
        run: flutter pub get

      - name: Generate Mocks & Code
        run: dart run build_runner build --delete-conflicting-outputs

      # ðŸ›¡ï¸ Quality Gates
      - name: Analyze code
        continue-on-error: true
        run: flutter analyze

      - name: Run Tests
        run: flutter test

  # -----------------------------------------------------------------------------
  # Job 2: Build (Windows App & MSIX)
  # -----------------------------------------------------------------------------
  build_windows:
    name: ðŸ—ï¸ Build Windows App
    needs: quality_check
    runs-on: windows-latest
    defaults:
      run:
        working-directory: apps/terminal
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_number: ${{ steps.version.outputs.version_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Extract version and auto-increment with Build Number (Persistent)
      - name: Check and Increment Version
        id: version
        shell: bash
        run: |
          echo "ðŸ”Ž Reading version from pubspec.yaml..."
          # Read base version (e.g., 0.0.3+45)
          FULL_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          
          # Extract parts
          BASE_VERSION=$(echo $FULL_VERSION | sed 's/+.*//')
          BUILD_NUMBER=$(echo $FULL_VERSION | sed 's/.*+//')
          
          # Increment Build Number
          NEW_BUILD_NUMBER=$((BUILD_NUMBER + 1))
          NEW_FULL_VERSION="$BASE_VERSION+$NEW_BUILD_NUMBER"
          
          echo "ðŸš€ Auto-incrementing version: $FULL_VERSION -> $NEW_FULL_VERSION"
          
          # Update pubspec.yaml
          sed -i "s/version: $FULL_VERSION/version: $NEW_FULL_VERSION/" pubspec.yaml
          
          # Commit and Push the new version so the next run starts higher
          # This prevents "Duplicate Package Identity" errors in Windows Store
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add pubspec.yaml
          git commit -m "chore: bump windows build number to $NEW_BUILD_NUMBER [skip ci]"
          git pull --rebase origin beta
          git push
          
          # Output for subsequent steps
          # msix uses x.y.z.w format usually, but updating pubspec handles it
          echo "version=v$NEW_FULL_VERSION" >> $GITHUB_OUTPUT
          echo "version_number=$NEW_FULL_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-v2'

      # Create .env file from secrets
      - name: Create .env file
        shell: bash
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name: Create firebase_options.dart
        shell: bash
        env:
          FIREBASE_OPTIONS_BASE64: ${{ secrets.TERMINAL_FIREBASE_OPTIONS_BASE64 }}
        run: |
          if [ -n "$FIREBASE_OPTIONS_BASE64" ]; then
            echo "$FIREBASE_OPTIONS_BASE64" | base64 --decode > lib/firebase_options.dart
          else
            echo "::warning::TERMINAL_FIREBASE_OPTIONS_BASE64 not set, build may fail"
          fi

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      # ðŸ—ï¸ Build
      - name: Build Windows Release
        run: flutter build windows --release

      - name: Create MSIX
        run: dart run msix:create
        env:
          temp: true

      - name: Stage Artifacts
        shell: bash
        run: |
          mkdir -p staging
          cp build/windows/x64/runner/Release/*.msix staging/

      - name: Upload MSIX Artifact
        uses: actions/upload-artifact@v4
        with:
          name: milow-terminal-msix
          path: staging/*
          retention-days: 1

  # -----------------------------------------------------------------------------
  # Job 3: Release (MS Store & GitHub)
  # -----------------------------------------------------------------------------
  release:
    name: ðŸš€ Release
    needs: build_windows
    runs-on: windows-latest
    defaults:
      run:
        working-directory: apps/terminal
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: milow-terminal-msix
          path: apps/terminal/artifacts

      # ðŸ“ Changelog
      - name: Generate Changelog
        id: changelog
        shell: bash
        run: |
          echo "ðŸ“ Generating changelog..."
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s|%h")
          else
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s|%h" --no-merges)
          fi

          # Simple changelog generation
          echo "# What's New" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          while IFS='|' read -r MSG HASH; do
             if [ -n "$MSG" ]; then
               echo "- $MSG" >> RELEASE_NOTES.md
             fi
          done <<< "$COMMITS"
          
          cat RELEASE_NOTES.md

      # ðŸ“¦ Publish to Store
      - name: Install Microsoft Store CLI
        run: |
          winget install Microsoft.DotNet.DesktopRuntime.8 --accept-source-agreements --accept-package-agreements --silent
          winget install "Microsoft Store Developer CLI" --accept-source-agreements --accept-package-agreements --silent

      - name: Publish to Microsoft Store
        shell: pwsh
        run: |
          # Validation
          if (-not $env:WINDOWS_STORE_TENANT_ID) { Write-Error "WINDOWS_STORE_TENANT_ID is missing"; exit 1 }
          if (-not $env:WINDOWS_STORE_CLIENT_ID) { Write-Error "WINDOWS_STORE_CLIENT_ID is missing"; exit 1 }
          if (-not $env:WINDOWS_STORE_CLIENT_SECRET) { Write-Error "WINDOWS_STORE_CLIENT_SECRET is missing"; exit 1 }
          if (-not $env:WINDOWS_STORE_SELLER_ID) { Write-Error "WINDOWS_STORE_SELLER_ID is missing"; exit 1 }

          Write-Host "Reconfiguring MSStore CLI..."
          msstore reconfigure --tenantId $env:WINDOWS_STORE_TENANT_ID --clientId $env:WINDOWS_STORE_CLIENT_ID --clientSecret $env:WINDOWS_STORE_CLIENT_SECRET --sellerId $env:WINDOWS_STORE_SELLER_ID --verbose

          if ($LASTEXITCODE -ne 0) { Write-Error "msstore reconfigure failed"; exit 1 }

          Write-Host "Listing available apps..."
          msstore apps list

          Write-Host "Publishing to Store..."
          msstore publish --inputDirectory artifacts --appId $env:WINDOWS_STORE_APP_ID --verbose
        env:
          WINDOWS_STORE_TENANT_ID: ${{ secrets.WINDOWS_STORE_TENANT_ID }}
          WINDOWS_STORE_CLIENT_ID: ${{ secrets.WINDOWS_STORE_CLIENT_ID }}
          WINDOWS_STORE_CLIENT_SECRET: ${{ secrets.WINDOWS_STORE_CLIENT_SECRET }}
          WINDOWS_STORE_SELLER_ID: ${{ secrets.WINDOWS_STORE_SELLER_ID }}
          WINDOWS_STORE_APP_ID: ${{ secrets.WINDOWS_STORE_APP_ID }}

      # ðŸš€ GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.build_windows.outputs.version }}
          name: Release ${{ needs.build_windows.outputs.version }}
          body_path: apps/terminal/RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: artifacts/*.msix
